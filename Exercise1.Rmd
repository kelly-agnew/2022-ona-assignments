---
title: "Exercise1"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Imports
```{r}
# graph analysis
library(ggraph)
library(igraph)

# tidy data analysis and visualziation
library(readr)
library(dplyr)
library(skimr)
```


## Read Data
```{r}
connections = read.csv("Data\\Connections.csv")
```


## Cleaning
```{r}
connections = subset(connections, select=-c(Email.Address))
connections %>% skim() #good to go
```


## Count of total connections
```{r}

connections %>% count()

```

## Count of connections by company
```{r}
connections %>% 
  count(Company) %>% 
  arrange(-n)

```



## Preprocessing for graphing
### First create new dataframe to store all possible pairs of nodes and their companies
```{r}
connections$Nodes = paste(connections$First.Name, substr(connections$Last.Name,0,3)) # Node names are first + first three letters of last name (I encountered some duplicates still with only using First name & first letter of last name, using three letters should solve this issue)

graphDF <- merge(connections$Nodes, connections$Nodes, by=NULL) # all possible connections

# R magic incoming:
# We have all possible pairs, but we want to remove duplicated pairs
# Ie, Kelly-->Bob is the same as Bob-->Kelly for our purposes
# To achieve this we do an in-row sorting to align all names in one column, then remove the duplicate rows
graphDF = graphDF[!duplicated(t(apply(graphDF, 1, sort))), ]

graphDF = graphDF %>% rename(person1=x, person2=y) #fix col names

# Get companies for person 1
graphDF = merge(x=graphDF, y=subset(connections, select=c(Company,Nodes)), by.x="person1", by.y="Nodes", all.x=TRUE)
graphDF = graphDF %>% rename(company1=Company) # company for person 1
# drop blanks from merge
graphDF = graphDF[!(is.na(graphDF$person1) | graphDF$person1==" "), ]
graphDF = graphDF[!(is.na(graphDF$company1) | graphDF$company1==""), ]


# Get companies for person 2
graphDF = merge(x=graphDF, y=subset(connections, select=c(Company,Nodes)), by.x="person2", by.y="Nodes", all.x=TRUE)
graphDF = graphDF %>% rename(company2=Company) # company for person 2
# blanks
graphDF = graphDF[!(is.na(graphDF$person2) | graphDF$person2==" "), ]
graphDF = graphDF[!(is.na(graphDF$company2) | graphDF$company2==""), ]


```


### Now we find overlapping companies between columns to establish graph edges
```{r}
graphDF = graphDF %>% mutate (
  edge = case_when(
    company1==company2 ~ 1,
    TRUE ~ 0
  )
)
```


### Now select the edges according to edge==1 for our edgelist and remove self-links
```{r}
graphDF = graphDF[!(graphDF$edge==0), ]
graphDF = graphDF[!(graphDF$person2==graphDF$person1),] # remove self links
# Drop unneeded columns to generate final edge list
edgeList = subset(graphDF, select=-c(edge, company2))
vertexList = subset(connections, select=c(Nodes, Company))
```




## Visualize graph with igraph
```{r}
linkedIn_graph = graph_from_data_frame(d=edgeList,vertices=NULL ,directed=FALSE)
linkedIn_graph

```

## Visualize
```{r}
ggraph(linkedIn_graph, layout="kk") +
  geom_edge_link(aes(color=factor(company1))) +
  geom_node_text(aes(label=name)) +
  theme(legend.position = "bottom")

```
